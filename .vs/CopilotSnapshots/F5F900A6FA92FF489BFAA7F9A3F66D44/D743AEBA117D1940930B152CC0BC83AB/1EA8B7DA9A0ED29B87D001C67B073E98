using System;
using System.Runtime.Caching;

namespace ProxyCacheService.Caching
{
    /// <summary>
    /// Small generic cache wrapper that stores instances of T in MemoryCache keyed by a string.
    /// The default behavior expects T to have a constructor that accepts a single string key.
    /// For more control you can provide a factory function via the constructor.
    /// </summary>
    public class GenericProxyCache<T> where T : class
    {
        private readonly MemoryCache _cache = MemoryCache.Default;
        public DateTimeOffset dt_default;
        private readonly Func<string, T> _factory;

        /// <summary>
        /// Default constructor: uses the Activator to call a constructor T(string key).
        /// </summary>
        public GenericProxyCache() : this(DefaultFactory)
        {
        }

        /// <summary>
        /// Constructor that accepts a factory function used to create new instances of T from a key.
        /// This avoids requiring a public parameterless constructor on T.
        /// </summary>
        public GenericProxyCache(Func<string, T> factory)
        {
            dt_default = ObjectCache.InfiniteAbsoluteExpiration; // no expiration by default
            _factory = factory ?? throw new ArgumentNullException(nameof(factory));
        }

        private static T DefaultFactory(string key)
        {
            var obj = Activator.CreateInstance(typeof(T), key) as T;
            if (obj == null)
                throw new InvalidOperationException($"Type {typeof(T).FullName} must have a public constructor .ctor(string) or you must supply a factory.");
            return obj;
        }

        public T Get(string cacheItemName)
        {
            return GetInternal(cacheItemName, dt_default);
        }

        public T Get(string cacheItemName, double dt_seconds)
        {
            var abs = DateTimeOffset.Now.AddSeconds(dt_seconds);
            return GetInternal(cacheItemName, abs);
        }

        public T Get(string cacheItemName, DateTimeOffset dt)
        {
            return GetInternal(cacheItemName, dt);
        }

        private T GetInternal(string key, DateTimeOffset absExpiration)
        {
            if (_cache.Get(key) is T obj)
            {
                System.Diagnostics.Debug.WriteLine($"[{DateTime.Now:T}] Cache HIT for key '{key}'");
                return obj;
            }

            System.Diagnostics.Debug.WriteLine($"[{DateTime.Now:T}] Cache MISS for key '{key}'");

            // Create the instance using the configured factory
            obj = _factory(key) ?? throw new InvalidOperationException($"Factory for type {typeof(T).FullName} returned null.");

            _cache.Set(key, obj, absExpiration);
            return obj;
        }
    }
}

