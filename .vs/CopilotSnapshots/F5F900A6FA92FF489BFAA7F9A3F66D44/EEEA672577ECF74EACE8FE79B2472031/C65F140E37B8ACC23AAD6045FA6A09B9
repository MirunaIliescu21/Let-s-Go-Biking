using System;
using System.Runtime.Caching;

namespace ProxyCacheService.Caching
{
    public class GenericProxyCache<T> where T : class, new()
    {
        private readonly MemoryCache _cache = MemoryCache.Default;
        public DateTimeOffset dt_default;

        public GenericProxyCache()
        {
            dt_default = ObjectCache.InfiniteAbsoluteExpiration; // without expiration by default
        }

        public T Get(string cacheItemName)
        {
            return GetInternal(cacheItemName, dt_default);
        }

        public T Get(string cacheItemName, double dt_seconds)
        {
            var dt = DateTimeOffset.UtcNow.AddSeconds(dt_seconds);
            return GetInternal(cacheItemName, dt);
        }

        public T Get(string cacheItemName, DateTimeOffset dt)
        {
            return GetInternal(cacheItemName, dt);
        }

        private T GetInternal(string key, DateTimeOffset absExpiration)
        {
            if (_cache.Get(key) is T obj) return obj;

            // Create an instance of T using the constructor that takes a string parameter (the key).
            obj = Activator.CreateInstance(typeof(T), key) as T
                  ?? throw new InvalidOperationException($"Type {typeof(T).Name} needs ctor(string).");

            _cache.Set(key, obj, absExpiration);
            return obj;
        }
    }
}
